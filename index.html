<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEM.tv Live Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #cbd5e1; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(71, 85, 105, 0.2); backdrop-filter: blur(12px); transition: all 0.3s ease; }
        .glass-card:hover { border-color: rgba(99, 102, 241, 0.4); transform: translateY(-2px); }
        .sidebar-item { transition: all 0.2s ease; border-right: 3px solid transparent; }
        .sidebar-item.active { background: rgba(99, 102, 241, 0.1); color: #818cf8; border-right-color: #6366f1; }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <nav class="fixed left-0 top-0 bottom-0 w-20 hidden lg:flex flex-col items-center py-8 border-r border-slate-800 bg-[#0f172a] z-50">
        <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center mb-10 shadow-lg shadow-indigo-600/30">
            <i data-lucide="zap" class="text-white w-6 h-6"></i>
        </div>
        <div class="flex flex-col gap-4 w-full">
            <button onclick="showPage('overview', this)" class="sidebar-item active w-full py-4 flex justify-center text-slate-500 hover:text-indigo-400">
                <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
            </button>
            <button onclick="showPage('content', this)" class="sidebar-item w-full py-4 flex justify-center text-slate-500 hover:text-indigo-400">
                <i data-lucide="play-circle" class="w-6 h-6"></i>
            </button>
            <button onclick="showPage('users', this)" class="sidebar-item w-full py-4 flex justify-center text-slate-500 hover:text-indigo-400">
                <i data-lucide="users" class="w-6 h-6"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-20 p-4 md:p-10">
        
        <!-- Top Bar -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
            <div>
                <h1 id="page-title" class="text-3xl font-bold text-white">Live Dashboard</h1>
                <p id="last-updated" class="text-slate-500 text-sm mt-1">Connecting to live feed...</p>
            </div>
            <div class="flex gap-3">
                <button onclick="fetchSheetData()" class="flex items-center gap-2 px-4 py-2 bg-slate-800 border border-slate-700 rounded-xl text-sm font-medium hover:bg-slate-700 transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-icon"></i> Refresh Data
                </button>
            </div>
        </div>

        <!-- Section: Overview -->
        <div id="overview-section">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-slate-400 text-sm font-medium">Total Users</p>
                    <h3 id="stat-total-users" class="text-3xl font-bold text-white mt-1">---</h3>
                    <div id="stat-users-change" class="mt-2 text-xs font-bold">--</div>
                </div>
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-slate-400 text-sm font-medium">Total Views</p>
                    <h3 id="stat-total-views" class="text-3xl font-bold text-white mt-1">---</h3>
                    <div id="stat-views-change" class="mt-2 text-xs font-bold">--</div>
                </div>
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-slate-400 text-sm font-medium">Paid Members</p>
                    <h3 id="stat-paid-members" class="text-3xl font-bold text-white mt-1">---</h3>
                    <div id="stat-members-change" class="mt-2 text-xs font-bold">--</div>
                </div>
                <div class="glass-card p-6 rounded-3xl">
                    <p class="text-slate-400 text-sm font-medium">Avg Views/User</p>
                    <h3 id="stat-avg-views" class="text-3xl font-bold text-white mt-1">---</h3>
                    <div class="mt-2 text-xs text-slate-500">Weekly Engagement</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 glass-card p-8 rounded-[2rem]">
                    <h3 class="text-lg font-bold text-white mb-6">User Growth & Engagement</h3>
                    <div class="h-[350px]">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-8 rounded-[2rem]">
                    <h3 class="text-lg font-bold text-white mb-6">User Composition</h3>
                    <div class="h-[250px] relative">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="mt-8 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">Paid Members</span>
                            <span id="label-paid" class="text-indigo-400 font-bold">--</span>
                        </div>
                        <div class="flex justify-between text-sm border-t border-slate-800 pt-3">
                            <span class="text-slate-400">Free Users</span>
                            <span id="label-free" class="text-slate-500 font-bold">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Other -->
        <div id="other-page" class="hidden py-20 text-center glass-card rounded-[2rem]">
            <i data-lucide="lock" class="w-12 h-12 text-slate-600 mx-auto mb-4"></i>
            <h2 id="other-title" class="text-xl font-bold text-white">Advanced View</h2>
            <p class="text-slate-500 mt-2">Connecting additional dataset rows for this view...</p>
        </div>

    </main>

    <script>
        // Use the specific CSV export URL provided
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3L1IDe_VJJ68CFNuQocvwBfl3NQeQnbU20W86mRwe6tF3Em416fL5sdrpyL4JxPTwTtDiptYmgzBN/pub?output=csv"; 

        let charts = {};

        async function fetchSheetData() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('animate-spin');
            
            try {
                const response = await fetch(SHEET_CSV_URL);
                const csvData = await response.text();
                // Simple CSV parser that handles basic quotes if needed
                const rows = csvData.split('\n').map(row => {
                    const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    return matches ? matches.map(m => m.replace(/"/g, '')) : row.split(',');
                });
                
                // Get the very last non-empty row
                const validRows = rows.filter(r => r.length > 5 && r[1]);
                const lastRow = validRows[validRows.length - 1];
                const historyRows = validRows.slice(-6); // Last 6 weeks for trend line

                updateDashboard(lastRow, historyRows);
                document.getElementById('last-updated').innerText = "Last updated: " + new Date().toLocaleTimeString();
            } catch (error) {
                console.error("Error fetching sheet:", error);
                document.getElementById('last-updated').innerText = "Error: Check 'Publish to Web' settings.";
            } finally {
                setTimeout(() => icon.classList.remove('animate-spin'), 600);
            }
        }

        function updateDashboard(current, history) {
            // Mapping based on LookerStudio index logic from your files
            // Index 2: Total Users, 12: Total Views, 17: Active Member Users
            const users = current[2] || "0";
            const views = current[12] || "0";
            const members = current[17] || "0";
            const avg = current[14] || "0";

            document.getElementById('stat-total-users').innerText = users;
            document.getElementById('stat-total-views').innerText = views;
            document.getElementById('stat-paid-members').innerText = members;
            document.getElementById('stat-avg-views').innerText = avg;

            // Trend percentages
            updateTrend('stat-users-change', current[3]);
            updateTrend('stat-views-change', current[13]);
            updateTrend('stat-members-change', current[18]);

            // Legends
            document.getElementById('label-paid').innerText = members;
            document.getElementById('label-free').innerText = current[19] || "0";

            renderMainChart(history);
            renderPieChart(current);
        }

        function updateTrend(id, val) {
            const el = document.getElementById(id);
            if (!val) { el.innerHTML = "0% vs last week"; return; }
            const isDown = val.includes('-') || val.includes('ðŸ”»');
            el.className = `mt-2 text-xs font-bold ${isDown ? 'text-rose-400' : 'text-emerald-400'}`;
            el.innerHTML = `<span>${val} vs last week</span>`;
        }

        function renderMainChart(history) {
            const labels = history.map(r => r[1] || 'Week');
            const userData = history.map(r => parseInt(r[2]?.replace(/,/g, '')) || 0);
            const viewData = history.map(r => parseInt(r[12]?.replace(/,/g, '')) || 0);

            if(charts.main) charts.main.destroy();

            const ctx = document.getElementById('mainChart').getContext('2d');
            charts.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { 
                            label: 'Users', 
                            data: userData, 
                            borderColor: '#6366f1', 
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.4 
                        },
                        { 
                            label: 'Views', 
                            data: viewData, 
                            borderColor: '#10b981', 
                            backgroundColor: 'rgba(16, 185, 129, 0.05)',
                            fill: true,
                            tension: 0.4 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, labels: { color: '#94a3b8' } } },
                    scales: {
                        y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
                        x: { ticks: { color: '#64748b' }, grid: { display: false } }
                    }
                }
            });
        }

        function renderPieChart(current) {
            const paid = parseInt(current[17]?.replace(/,/g, '')) || 0;
            const free = parseInt(current[19]?.replace(/,/g, '')) || 0;

            if(charts.pie) charts.pie.destroy();

            const ctx = document.getElementById('pieChart').getContext('2d');
            charts.pie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Free'],
                    datasets: [{
                        data: [paid, free],
                        backgroundColor: ['#6366f1', '#1e293b'],
                        hoverOffset: 4,
                        borderWidth: 0
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { display: false } } }
            });
        }

        function showPage(page, btn) {
            // Update Sidebar UI
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');

            const overview = document.getElementById('overview-section');
            const other = document.getElementById('other-page');
            const title = document.getElementById('page-title');
            const otherTitle = document.getElementById('other-title');

            if (page === 'overview') {
                overview.classList.remove('hidden');
                other.classList.add('hidden');
                title.innerText = "Live Dashboard";
            } else {
                overview.classList.add('hidden');
                other.classList.remove('hidden');
                title.innerText = page.charAt(0).toUpperCase() + page.slice(1);
                otherTitle.innerText = page.charAt(0).toUpperCase() + page.slice(1) + " Analytics";
            }
        }

        // Initialize
        lucide.createIcons();
        fetchSheetData();
        // Sync every 2 minutes
        setInterval(fetchSheetData, 120000);
    </script>
</body>
</html>
